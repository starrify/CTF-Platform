// Generated by CoffeeScript 1.6.3
(function() {
  window.show_site_down_error = function() {
    $(".contentbox").html("<div class=\"row-fluid\"><div class=\"offset1 span10\"><div class=\"alert\"><button type=\"button\" class=\"close\" data-dismiss=\"alert\">&times;</button>发生了未知错误. 请联系<a href=\"mailto:actf.zju@gmail.com\">actf.zju@gmail.com</a></div></div></div>");
  };

  window.is_zju_text = {
    'true': '（校内用户）',
    'false': '（校外用户）'
  };

  window.scoreboard_text_zju = {
    'true': '排名（校内）',
    'false': '排名（校外）'
  };

  window.set_navbar_zju = function(teamname, is_zju_user) {
    var i, _results;
    i = 0;
    _results = [];
    while (i < tabsLI.length) {
      if (tabsLI[i][0] === 'account') {
        tabsLI[i][1] = teamname;
      }
      if (tabsLI[i][0] === 'scoreboard') {
        tabsLI[i][1] = scoreboard_text_zju[is_zju_user];
      }
      _results.push(i++);
    }
    return _results;
  };

  window.build_navbar = function(tabs) {
    var i, ohtml;
    ohtml = "";
    i = 0;
    while (i < tabs.length) {
      if (window.location.href.indexOf(tabs[i][0]) !== -1) {
        ohtml += "<li class=\"ts_selected\" id=\"ts_" + tabs[i][0] + "\"><a href=\"" + tabs[i][0] + "\">" + tabs[i][1] + "</a></li>";
      } else {
        ohtml += "<li id=\"ts_" + tabs[i][0] + "\"><a href=\"" + tabs[i][0] + "\">" + tabs[i][1] + "</a></li>";
      }
      i++;
    }
    $("#navbar")[0].innerHTML = ohtml;
  };

  /*
  window.add_certs_link = ->
    ohtml = $("#navbar")[0].innerHTML
    unless window.location.href.indexOf("certificates") is -1
      ohtml = "<li class=\"ts_selected\" id=\"ts_certificates\"><a href=\"certificates\">Certificates</a></li>" + ohtml
    else
      ohtml = "<li id=\"ts_certificates\"><a href=\"certificates\">Certificates</a></li>" + ohtml
    $("#navbar")[0].innerHTML = ohtml
    return
    
  window.check_certs_link_necessary = ->
    unless typeof (Storage) is "undefined"
      if sessionStorage.showCertsLink is "true"
        add_certs_link()
      else
        $.ajax(
          type: "GET"
          url: "/api/getlevelcompleted"
          cache: false
        ).done((data) ->
          if data["success"] is 1 and data["level"] > 0
            sessionStorage.showCertsLink = "true"
            add_certs_link()
          else
            sessionStorage.showCertsLink = "false"
          return
        ).fail (data) ->
          sessionStorage.showCertsLink = "false"
          return
  
    else
      $.ajax(
        type: "GET"
        url: "/api/getlevelcompleted"
        cache: false
      ).done (data) ->
        add_certs_link()  if data["success"] is 1 and data["level"] > 0
        return
  
    return
  */


  window.display_navbar = function() {
    if (typeof Storage !== "undefined") {
      if (sessionStorage.signInStatus === "loggedIn") {
        set_navbar_zju(sessionStorage.teamname, sessionStorage.is_zju_user);
        build_navbar(tabsLI);
      } else if (sessionStorage.signInStatus === "notLoggedIn") {
        build_navbar(tabsNLI);
      } else if (sessionStorage.signInStatus === "apiFail") {
        build_navbar(tabsFail);
      } else {
        build_navbar(tabsNLI);
      }
      $.ajax({
        type: "GET",
        url: "/api/isloggedin",
        cache: false
      }).done(function(data) {
        if (data["success"] === 1 && sessionStorage.signInStatus !== "loggedIn") {
          sessionStorage.signInStatus = "loggedIn";
          sessionStorage.teamname = data['teamname'];
          sessionStorage.is_zju_user = data['is_zju_user'];
          set_navbar_zju(sessionStorage.teamname, sessionStorage.is_zju_user);
          build_navbar(tabsLI);
        } else if (data["success"] === 0 && sessionStorage.signInStatus !== "notLoggedIn") {
          sessionStorage.signInStatus = "notLoggedIn";
          build_navbar(tabsNLI);
        }
      }).fail(function() {
        if (sessionStorage.signInStatus !== "apiFail") {
          sessionStorage.signInStatus = "apiFail";
          build_navbar(tabsFail);
          show_site_down_error();
        }
      });
    } else {
      $.ajax({
        type: "GET",
        url: "/api/isloggedin",
        cache: false
      }).done(function(data) {
        if (data['success']) {
          set_navbar_zju(data['teamname'], data['is_zju_user']);
        }
        build_navbar((data["success"] === 1 ? tabsLI : tabsNLI));
      }).fail(function() {
        build_navbar(tabsFail);
        show_site_down_error();
      });
    }
  };

  window.load_footer = function() {
    $.ajax({
      type: "GET",
      cache: false,
      url: "deps/footer.html"
    }).done(function(data) {
      $("#footer").html(data);
    });
  };

  window.handle_submit = function(prob_id) {
    var rid;
    $.ambiance({
      message: "答案正在审核，请稍候",
      type: "success",
      timeout: 2
    });
    $.ajax({
      type: "POST",
      cache: false,
      url: "/api/submit",
      dataType: "json",
      async: false,
      data: {
        pid: prob_id,
        key: $("#" + prob_id).val(),
        recaptcha_challenge: Recaptcha.get_challenge(),
        recaptcha_response: Recaptcha.get_response()
      }
    }).done(function(data) {
      if (data['status'] === 0) {
        $.ambiance({
          message: data["message"],
          type: "error",
          timeout: 10
        });
      } else if (data['status'] === 1) {
        $.ambiance({
          message: data["message"],
          type: "success",
          timeout: 7
        });
        $("#problem-status-" + prob_id).attr("class", "solved");
        $("#problem-status-" + prob_id).html("[已解决]");
      }
    });
    rid = "recaptcha-".concat(prob_id);
    return false;
  };

  window.redirect_if_not_logged_in = function() {
    $.ajax({
      type: "GET",
      url: "/api/isloggedin",
      cache: false
    }).done(function(data) {
      if (data["success"] === 0) {
        window.location.href = "/login";
      }
    }).fail(function() {
      window.location.href = "/";
    });
  };

  window.tabsLI = [["rules", "规则"], ["problems", "题目"], ["scoreboard", "排名（校外）"], ["account", "账户信息"], ["logout", "注销"]];

  window.tabsNLI = [["rules", "规则"], ["scoreboard", "排名（校外）"], ["registration", "注册"], ["login", "登录"]];

  window.tabsFail = [["rules", "规则"], ["registration", "注册"], ["login", "登录"]];

}).call(this);
